name: atlas

services:
  # ─────────────────────────────────────────────────────────────────────────────
  # Atlas API Server
  # ─────────────────────────────────────────────────────────────────────────────
  atlas:
    build:
      context: .
      dockerfile: Dockerfile
    image: atlas:latest
    container_name: atlas-server
    ports:
      - "8000:8000"
    env_file:
      - .env
    environment:
      # Override for container networking
      - MONGODB_URI=mongodb://mongodb:27017
      - ATLAS_RAG_QDRANT_HOST=qdrant
      - ATLAS_SKIP_DB_HEALTH_CHECK=1
      - ATLAS_LAZY_AI_IMPORTS=1
    volumes:
      # Persistent data
      - atlas_data:/app/data
      - atlas_logs:/app/logs
    # VPN DNS servers for internal service resolution
    # Update these IPs if your VPN uses different DNS servers
    dns:
      - 10.0.10.101
      - 10.20.10.15
      - 8.8.8.8
    depends_on:
      mongodb:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -so /dev/null -w '%{http_code}' http://localhost:8000/api/health | grep -qE '^(200|401)$'"]
      interval: 30s
      timeout: 10s
      start_period: 60s
      retries: 3

  # ─────────────────────────────────────────────────────────────────────────────
  # MongoDB Database
  # ─────────────────────────────────────────────────────────────────────────────
  mongodb:
    image: mongo:7.0
    container_name: atlas-mongodb
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
    environment:
      - MONGO_INITDB_DATABASE=atlas
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ─────────────────────────────────────────────────────────────────────────────
  # Qdrant Vector Database (for Confluence RAG)
  # ─────────────────────────────────────────────────────────────────────────────
  qdrant:
    image: qdrant/qdrant:latest
    container_name: atlas-qdrant
    profiles:
      - rag
      - full
    ports:
      - "6333:6333"  # REST API
      - "6334:6334"  # gRPC
    volumes:
      - qdrant_storage:/qdrant/storage
    environment:
      - QDRANT__LOG_LEVEL=INFO
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/readyz"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ─────────────────────────────────────────────────────────────────────────────
  # Slack Bot (Socket Mode - no public endpoints required)
  # Start with: docker compose --profile bots up -d slack-bot
  # ─────────────────────────────────────────────────────────────────────────────
  slack-bot:
    image: atlas:latest
    container_name: atlas-slack-bot
    profiles:
      - bots
      - full
    env_file:
      - .env
    environment:
      - MONGODB_URI=mongodb://mongodb:27017
      - ATLAS_STORAGE_BACKEND=mongodb
      - ATLAS_RAG_QDRANT_HOST=qdrant
      # Required for Slack Socket Mode:
      # - SLACK_BOT_TOKEN=xoxb-your-bot-token
      # - SLACK_APP_TOKEN=xapp-your-app-level-token
    command: ["python", "-m", "infrastructure_atlas.cli", "bots", "run-slack"]
    # VPN DNS servers for internal service resolution (if needed)
    dns:
      - 10.0.10.101
      - 10.20.10.15
      - 8.8.8.8
    depends_on:
      mongodb:
        condition: service_healthy
    restart: unless-stopped
    # Slack bot uses Socket Mode (WebSocket) - no healthcheck endpoint needed
    # The bot will automatically reconnect if connection drops
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

  # ─────────────────────────────────────────────────────────────────────────────
  # Telegram Bot (Polling Mode - no public endpoints required)
  # Start with: docker compose --profile bots up -d telegram-bot
  # ─────────────────────────────────────────────────────────────────────────────
  telegram-bot:
    image: atlas:latest
    container_name: atlas-telegram-bot
    profiles:
      - bots
      - full
    env_file:
      - .env
    environment:
      - MONGODB_URI=mongodb://mongodb:27017
      - ATLAS_STORAGE_BACKEND=mongodb
      # Required:
      # - TELEGRAM_BOT_TOKEN=your-bot-token-from-botfather
    command: ["python", "-m", "infrastructure_atlas.cli", "bots", "run-telegram"]
    # VPN DNS servers for internal service resolution (if needed)
    dns:
      - 10.0.10.101
      - 10.20.10.15
      - 8.8.8.8
    depends_on:
      mongodb:
        condition: service_healthy
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  atlas_data:
    driver: local
  atlas_logs:
    driver: local
  mongodb_data:
    driver: local
  qdrant_storage:
    driver: local
