{{- $fullName := include "atlas.fullname" . -}}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ $fullName }}-config
  labels:
    {{- include "atlas.labels" . | nindent 4 }}
data:
  # General
  LOG_LEVEL: {{ .Values.config.logLevel | quote }}
  ATLAS_LOG_LEVEL: {{ .Values.config.logLevel | quote }}
  ATLAS_LOG_DIR: "logs"
  ATLAS_LOG_FILE: "atlas.log"
  UI_THEME_DEFAULT: {{ .Values.config.uiThemeDefault | quote }}
  
  # Storage backends
  ATLAS_STORAGE_BACKEND: {{ .Values.config.storageBackend | quote }}
  ATLAS_CACHE_BACKEND: {{ .Values.config.cacheBackend | quote }}
  
  # Module system
  {{- if .Values.config.modulesEnabled }}
  ATLAS_MODULES_ENABLED: {{ .Values.config.modulesEnabled | quote }}
  {{- end }}
  
  # MongoDB
  MONGODB_URI: {{ include "atlas.mongodbUri" . | quote }}
  MONGODB_DATABASE: {{ .Values.mongodb.database | quote }}
  MONGODB_CACHE_DATABASE: {{ .Values.mongodb.cacheDatabase | quote }}
  
  # Qdrant
  ATLAS_RAG_QDRANT_HOST: {{ .Values.qdrant.host | quote }}
  ATLAS_RAG_QDRANT_PORT: {{ .Values.qdrant.port | quote }}
  ATLAS_RAG_QDRANT_COLLECTION: {{ .Values.qdrant.collection | quote }}
  
  # Performance optimizations
  ATLAS_SKIP_DB_HEALTH_CHECK: "1"
  ATLAS_LAZY_AI_IMPORTS: "1"
  
  # RAG settings
  ATLAS_RAG_EMBEDDING_PROVIDER: "gemini"
  ATLAS_RAG_GEMINI_MODEL: "text-embedding-004"
  {{- if .Values.config.ragWatchedSpaces }}
  ATLAS_RAG_WATCHED_SPACES: {{ .Values.config.ragWatchedSpaces | quote }}
  {{- end }}
  {{- if .Values.config.ragWatchedLabels }}
  ATLAS_RAG_WATCHED_LABELS: {{ .Values.config.ragWatchedLabels | quote }}
  {{- end }}

  # Commvault config
  {{- if .Values.config.commvaultVerifyTls }}
  COMMVAULT_VERIFY_TLS: {{ .Values.config.commvaultVerifyTls | quote }}
  {{- else }}
  COMMVAULT_VERIFY_TLS: "0"
  {{- end }}

  # Zabbix config (non-sensitive)
  {{- if .Values.config.zabbixSeverities }}
  ZABBIX_SEVERITIES: {{ .Values.config.zabbixSeverities | quote }}
  {{- end }}
  {{- if .Values.config.zabbixGroupId }}
  ZABBIX_GROUP_ID: {{ .Values.config.zabbixGroupId | quote }}
  {{- end }}
  {{- if .Values.config.zabbixExcludeGroupPatterns }}
  ZABBIX_EXCLUDE_GROUP_PATTERNS: {{ .Values.config.zabbixExcludeGroupPatterns | quote }}
  {{- end }}
